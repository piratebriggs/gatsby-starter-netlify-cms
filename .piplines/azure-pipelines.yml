name: $(date:yyyyMMdd)$(rev:.r)-$(SourceBranchName)

trigger:
- master

pool:
  name: NBS-MC-NEL-SC-DEV-BUILD

variables:
  azureSubscriptionEndpoint: NEL-SPN
  azureContainerRegistry: jssproxy1975.azurecr.io
  image: $(azureContainerRegistry)/gatsby-starter-netlify-cms:$(Build.BuildNumber)

- script: |
    set -e

    echo "Image: $image"
  displayName: Build site

steps:
- task: NodeTool@0
  inputs:
    versionSpec: '14.x'
  displayName: 'Install Node.js'

- script: |
    node --version
    npm -v
    npm install
    npm run build
  displayName: 'yarn install and build'

- task: Docker@1
  displayName: Container registry login
  inputs:
    command: login
    azureSubscriptionEndpoint: $(azureSubscriptionEndpoint)
    azureContainerRegistry: $(azureContainerRegistry)

- script: |
    set -e

    echo "Building $image..."
    docker build -t $image .
    docker push $image
  displayName: Build site

- task: AzureWebAppContainer@1
  displayName: Azure Web App on Container Deploy
  inputs:
    appName: gatsby-netlify-cms
    azureSubscription: $(azureSubscriptionEndpoint)
    imageName: $(image)